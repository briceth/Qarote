name: Deploy Worker to Production

env:
  APP_NAME: rabbithq-worker-production
  BACKEND_APP_NAME: rabbithq

on:
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        default: ""

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Type Check
        working-directory: back-end
        run: npm run type-check

      - name: ğŸ§¹ Lint
        working-directory: back-end
        run: npm run lint

      - name: ğŸ’… Format Check
        working-directory: back-end
        run: npm run format

      - name: ğŸ§ª Run Tests
        working-directory: back-end
        run: npm run test:run

  ensure-worker-app:
    name: Ensure Worker App Exists
    runs-on: ubuntu-latest
    environment: production
    needs: quality-checks
    if: github.event.inputs.confirm_production == 'DEPLOY'

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: ğŸ—ï¸ Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.DOKKU_HOST_APP1 }} >> ~/.ssh/known_hosts

      - name: âœ… Check if backend app exists
        run: |
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} apps:exists ${{ env.BACKEND_APP_NAME }} || \
            (echo "Error: Backend app ${{ env.BACKEND_APP_NAME }} does not exist" && exit 1)

      - name: ğŸ—ï¸ Ensure worker app exists
        run: |
          if ! ssh dokku@${{ vars.DOKKU_HOST_APP1 }} apps:exists ${{ env.APP_NAME }}; then
            echo "Creating worker app..."
            ssh dokku@${{ vars.DOKKU_HOST_APP1 }} apps:create ${{ env.APP_NAME }}
          else
            echo "Worker app already exists"
          fi

      - name: ğŸ“‹ Copy config from backend app
        run: |
          echo "Exporting config from backend app..."
          CONFIG=$(ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:export ${{ env.BACKEND_APP_NAME }})
          echo "Importing config to worker app..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} "$CONFIG"

      - name: âš™ï¸ Set start command for worker
        run: |
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} ps:set ${{ env.APP_NAME }} start-cmd "npm run start:alert" || \
            echo "Note: Start command may already be set or format differs"

  deploy-worker:
    name: Deploy Worker to Production
    runs-on: ubuntu-latest
    environment: production
    needs: [quality-checks, ensure-worker-app]
    if: github.event.inputs.confirm_production == 'DEPLOY'

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: ğŸ—ï¸ Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.DOKKU_HOST_APP1 }} >> ~/.ssh/known_hosts

      # Deploy the application
      - name: ğŸ³ Deploy to Dokku
        uses: dokku/github-action@master
        with:
          git_remote_url: "ssh://dokku@${{ vars.DOKKU_HOST_APP1 }}:22/${{ env.APP_NAME }}"
          ssh_private_key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}
          git_push_flags: "--force"

      - name: ğŸ” Verify worker app status
        run: |
          echo "Checking worker app status..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} ps:report ${{ env.APP_NAME }}

      - name: ğŸ“ˆ Scale worker process
        run: |
          echo "Scaling worker process to 1..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} ps:scale ${{ env.APP_NAME }} worker=1 || \
            echo "Note: Worker process may need to be scaled manually"

      - name: ğŸ“‹ Show worker logs
        run: |
          echo "Recent worker logs:"
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} logs ${{ env.APP_NAME }} --tail 20 || true

      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ Worker deployment to production completed successfully!"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ” Worker app: ${{ env.APP_NAME }}"
          echo "ğŸ’¡ View logs: ssh dokku@${{ vars.DOKKU_HOST_APP1 }} logs ${{ env.APP_NAME }}"

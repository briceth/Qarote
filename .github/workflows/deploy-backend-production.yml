name: Deploy Backend to Production

env:
  APP_NAME: rabbithq

on:
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        default: ""

jobs:
  deploy-backend:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    environment: production
    if: github.event.inputs.confirm_production == 'DEPLOY'

    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: üèóÔ∏è Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.DOKKU_HOST_APP1 }} >> ~/.ssh/known_hosts

      - name: üèóÔ∏è Ensure app exists
        run: |
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} "apps:exists ${{ env.APP_NAME }} || apps:create ${{ env.APP_NAME }}"

      # Configure all environment variables
      - name: üìù Configure Environment Variables
        run: |
          echo "Setting environment variables one by one..."
          echo "1/23: Setting DATABASE_URL (CRITICAL)..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} DATABASE_URL=${{ secrets.DATABASE_URL }}
          echo "2/23: Setting DOMAIN_BACKEND..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} DOMAIN_BACKEND=${{ vars.DOMAIN_BACKEND }}
          echo "3/23: Setting DOMAIN_FRONTEND..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} DOMAIN_FRONTEND=${{ vars.DOMAIN_FRONTEND }}
          echo "4/23: Setting PORT..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} PORT=${{ vars.PORT }}
          echo "5/23: Setting HOST..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} HOST=${{ vars.HOST }}
          echo "6/23: Setting NODE_ENV..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} NODE_ENV=${{ vars.NODE_ENV }}
          echo "7/23: Setting ENVIRONMENT..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} ENVIRONMENT=production
          echo "8/23: Setting LOG_LEVEL..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} LOG_LEVEL=${{ vars.LOG_LEVEL }}
          echo "9/23: Setting JWT_SECRET..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} JWT_SECRET=${{ secrets.JWT_SECRET }}
          echo "10/23: Setting ENCRYPTION_KEY..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          echo "11/23: Setting CORS_ORIGIN..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} CORS_ORIGIN=${{ vars.CORS_ORIGIN }}
          echo "12/23: Setting FRONTEND_URL..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} FRONTEND_URL=${{ vars.FRONTEND_URL }}
          echo "13/23: Setting RESEND_API_KEY..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          echo "14/23: Setting FROM_EMAIL..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} FROM_EMAIL=${{ vars.FROM_EMAIL }}
          echo "15/23: Setting STRIPE_SECRET_KEY..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          echo "16/23: Setting STRIPE_WEBHOOK_SECRET..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          echo "17/23: Setting STRIPE_DEVELOPER_MONTHLY_PRICE_ID..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} STRIPE_DEVELOPER_MONTHLY_PRICE_ID=${{ vars.STRIPE_DEVELOPER_MONTHLY_PRICE_ID }}
          echo "18/23: Setting STRIPE_DEVELOPER_YEARLY_PRICE_ID..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} STRIPE_DEVELOPER_YEARLY_PRICE_ID=${{ vars.STRIPE_DEVELOPER_YEARLY_PRICE_ID }}
          echo "19/23: Setting STRIPE_ENTERPRISE_MONTHLY_PRICE_ID..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} STRIPE_ENTERPRISE_MONTHLY_PRICE_ID=${{ vars.STRIPE_ENTERPRISE_MONTHLY_PRICE_ID }}
          echo "20/23: Setting STRIPE_ENTERPRISE_YEARLY_PRICE_ID..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} STRIPE_ENTERPRISE_YEARLY_PRICE_ID=${{ vars.STRIPE_ENTERPRISE_YEARLY_PRICE_ID }}
          echo "21/23: Setting SENTRY_DSN..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} SENTRY_DSN=${{ vars.SENTRY_DSN }}
          echo "22/23: Setting SENTRY_ENABLED..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} SENTRY_ENABLED=${{ vars.SENTRY_ENABLED }}
          echo "23/23: Setting NODE_ID..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:set ${{ env.APP_NAME }} NODE_ID=app1
          echo "‚úÖ All environment variables configured successfully!"

      # Deploy the application
      - name: üê≥ Deploy to Dokku
        uses: dokku/github-action@master
        with:
          git_remote_url: "ssh://dokku@${{ vars.DOKKU_HOST_APP1 }}:22/${{ env.APP_NAME }}"
          ssh_private_key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}
          git_push_flags: "--force"

      - name: üîç Debug Dokku Environment
        run: |
          echo "Checking environment variables in Dokku..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} config:show ${{ env.APP_NAME }}
          echo "-----------------------------------------------"
          echo "Checking if app is running..."
          ssh dokku@${{ vars.DOKKU_HOST_APP1 }} ps:report ${{ env.APP_NAME }}

      - name: ü©∫ Verify health endpoints
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          echo "Testing health endpoint..."
          curl -sSf https://${{ vars.DOMAIN_BACKEND }}/health || echo "Health check not yet available, deployment may still be in progress"

      - name: ‚úÖ Deployment complete
        run: |
          echo "üéâ Deployment to production completed successfully!"
          echo "üîç Backend URL: https://${{ vars.DOMAIN_BACKEND }}"
          echo "üîç Health check: https://${{ vars.DOMAIN_BACKEND }}/health"
          echo "üìù Commit: ${{ github.sha }}"

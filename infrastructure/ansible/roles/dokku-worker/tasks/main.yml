---
# Dokku Worker Role - Main Tasks
# Manages Dokku worker app creation and configuration

- name: Check if backend app exists
  command: dokku apps:exists {{ backend_app_name }}
  register: backend_app_check
  changed_when: false
  failed_when: false

- name: Fail if backend app does not exist
  fail:
    msg: "Backend app {{ backend_app_name }} does not exist. Please create it first."
  when: backend_app_check.rc != 0

- name: Check if worker app exists
  command: dokku apps:exists {{ worker_app_name }}
  register: worker_app_check
  changed_when: false
  failed_when: false

- name: Create worker app
  command: dokku apps:create {{ worker_app_name }}
  when:
    - create_worker_app | default(true)
    - worker_app_check.rc != 0
  register: create_worker_result
  changed_when: worker_app_check.rc != 0

- name: Export config from backend app
  command: dokku config:export {{ backend_app_name }}
  register: backend_config
  changed_when: false
  when: worker_app_check.rc == 0 or create_worker_result is succeeded

- name: Import config to worker app
  command: dokku config:set {{ worker_app_name }} {{ backend_config.stdout }}
  when:
    - create_worker_app | default(true)
    - backend_config.stdout is defined
    - backend_config.stdout | length > 0
  register: import_config_result
  changed_when: import_config_result.rc == 0

- name: Set start command for worker process
  command: dokku ps:set {{ worker_app_name }} start-cmd "{{ worker_start_command }}"
  when:
    - create_worker_app | default(true)
    - worker_app_check.rc == 0 or create_worker_result is succeeded
  register: set_start_command_result
  failed_when: false # May fail if command format is different, that's okay
  changed_when: set_start_command_result.rc == 0

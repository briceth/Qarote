---
# Ansible Playbook: Dokku Worker App Management
# Creates and configures Dokku worker app for alert monitoring

- name: Manage Dokku Worker App
  hosts: "{{ target_environment | default('staging') }}"
  become: false
  gather_facts: false

  tasks:
    - name: Check if backend app exists
      raw: apps:list
      register: apps_list
      changed_when: false
      failed_when: false

    - name: Check backend app in list
      set_fact:
        backend_app_exists: "{{ backend_app_name in apps_list.stdout_lines }}"

    - name: Fail if backend app does not exist
      fail:
        msg: "Backend app {{ backend_app_name }} does not exist. Please create it first."
      when: not backend_app_exists

    - name: Check if worker app exists
      set_fact:
        worker_app_exists: "{{ worker_app_name in apps_list.stdout_lines }}"

    - name: Create worker app
      raw: apps:create {{ worker_app_name }}
      when:
        - create_worker_app | default(true)
        - not worker_app_exists
      register: create_worker_result

    - name: Export config from backend app
      raw: config:export {{ backend_app_name }}
      register: backend_config
      changed_when: false
      when: worker_app_exists or create_worker_result is succeeded

    - name: Process config for import (remove export prefix and join lines)
      set_fact:
        processed_config: "{{ backend_config.stdout_lines | map('regex_replace', '^export ', '') | join(' ') }}"
      when:
        - backend_config.stdout is defined
        - backend_config.stdout | length > 0

    - name: Import config to worker app
      raw: config:set {{ worker_app_name }} {{ processed_config }}
      when:
        - create_worker_app | default(true)
        - processed_config is defined
        - processed_config | length > 0
      register: import_config_result

    - name: Set start command for worker process
      raw: ps:set {{ worker_app_name }} start-cmd "{{ worker_start_command }}"
      when:
        - create_worker_app | default(true)
        - worker_app_exists or create_worker_result is succeeded
      register: set_start_command_result
      failed_when: false # May fail if command format is different, that's okay

    - name: Scale worker process
      raw: ps:scale {{ worker_app_name }} worker=1
      when:
        - create_worker_app | default(true)
        - worker_app_exists or create_worker_result is succeeded
      register: scale_worker_result
      failed_when: false # May fail if process type doesn't exist yet, that's okay

    - name: Display worker app information
      debug:
        msg:
          - "Worker app: {{ worker_app_name }}"
          - "Backend app: {{ backend_app_name }}"
          - "Start command: {{ worker_start_command }}"
          - "Status: {{ 'Created' if (worker_app_exists or create_worker_result is succeeded) else 'Not created' }}"
          - "Next step: Deploy code with 'git push dokku@{{ ansible_host }}:{{ worker_app_name }} main'"
